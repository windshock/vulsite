package com.vulsite;

import com.vulsite.entity.User;
import com.vulsite.repository.FileRepository;
import com.vulsite.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.mock.web.MockHttpSession;
import org.springframework.mock.web.MockMultipartFile;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.web.servlet.MockMvc;

import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.multipart;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.redirectedUrl;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
class BVulnerabilityTests {

    @TempDir
    static Path tempDir;

    @DynamicPropertySource
    static void registerProperties(DynamicPropertyRegistry registry) {
        registry.add("file.upload-dir", () -> tempDir.resolve("uploads").toString());
    }

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private FileRepository fileRepository;

    private MockHttpSession session;

    @BeforeEach
    void setUp() {
        User user = new User(
                "buser_" + UUID.randomUUID(),
                "password",
                "buser@vulsite.com",
                "B담당"
        );
        userRepository.save(user);
        session = new MockHttpSession();
        session.setAttribute("user", user);
    }

    @Test
    @DisplayName("보안 기대: 위험한 확장자/MIME 업로드는 차단되어야 함")
    void uploadAllowsDangerousExtension() throws Exception {
        MockMultipartFile file = new MockMultipartFile(
                "file",
                "shell.jsp",
                "application/octet-stream",
                "<% out.println('x'); %>".getBytes(StandardCharsets.UTF_8)
        );

        mockMvc.perform(multipart("/file/upload").file(file).session(session))
                .andExpect(status().is4xxClientError());

        boolean saved = fileRepository.findAll().stream()
                .anyMatch(info -> "shell.jsp".equals(info.getOriginalName()));

        assertTrue(!saved);
    }

    @Test
    @DisplayName("보안 기대: Path Traversal 시도는 차단되어야 함")
    void downloadAllowsPathTraversal() throws Exception {
        Path uploadDir = tempDir.resolve("uploads");
        Files.createDirectories(uploadDir);

        Path secret = tempDir.resolve("secret.txt");
        Files.write(secret, "secret".getBytes(StandardCharsets.UTF_8));

        mockMvc.perform(get("/file/download").param("filename", "../secret.txt"))
                .andExpect(status().is4xxClientError());
    }

    @Test
    @DisplayName("보안 기대: 관리자 페이지는 인증 없이 접근 불가해야 함")
    void adminDashboardAccessibleWithoutAuth() throws Exception {
        mockMvc.perform(get("/admin/dashboard"))
                .andExpect(status().is3xxRedirection())
                .andExpect(redirectedUrl("/user/login"));
    }
}
