package com.vulsite.vulnerability;

import com.microsoft.playwright.*;
import com.vulsite.entity.User;
import com.vulsite.repository.BoardRepository;
import com.vulsite.repository.UserRepository;
import org.junit.jupiter.api.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.server.LocalServerPort;

import java.nio.file.Path;
import java.nio.file.Paths;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * A담당 - 취약점 #2: Stored XSS 보안 테스트 (Playwright 브라우저 테스트)
 *
 * 테스트 시나리오 (보안 기대):
 * 1. 일반 텍스트 게시글은 정상 동작
 * 2. XSS 페이로드는 이스케이프되어 스크립트 실행 안됨
 */
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Tag("secure")
class StoredXssTest {

    @LocalServerPort
    private int port;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private BoardRepository boardRepository;

    private static Playwright playwright;
    private static Browser browser;
    private BrowserContext context;
    private Page page;
    private static final Path VIDEO_DIR = Paths.get("build", "playwright-videos");

    private String baseUrl;

    @BeforeAll
    static void setUpBrowser() {
        int slowMo = Integer.parseInt(System.getProperty("playwright.slowMo", "0"));
        playwright = Playwright.create();
        browser = playwright.chromium().launch(new BrowserType.LaunchOptions()
                .setHeadless(true)
                .setSlowMo(slowMo));
    }

    @AfterAll
    static void tearDownBrowser() {
        if (browser != null) browser.close();
        if (playwright != null) playwright.close();
    }

    @BeforeEach
    void setUp() {
        baseUrl = "http://localhost:" + port;
        context = browser.newContext(new Browser.NewContextOptions()
                .setRecordVideoDir(VIDEO_DIR)
                .setRecordVideoSize(720, 1280)
                .setViewportSize(720, 1280)
                .setDeviceScaleFactor(1.0));
        context.addInitScript(
                "(() => {" +
                "const style = document.createElement('style');" +
                "style.innerHTML = 'html,body{background:#0b0f1a !important;}';" +
                "(document.head || document.documentElement).appendChild(style);" +
                "})()"
        );
        page = context.newPage();

        if (userRepository.findByUsername("xsstest").isEmpty()) {
            User xssUser = new User("xsstest", "xsspass", "xss@test.com", "XSS테스터");
            userRepository.save(xssUser);
        }
    }

    @AfterEach
    void tearDown() {
        if (context != null) context.close();
    }

    private void login(String username, String password) {
        page.navigate(baseUrl + "/user/login");
        page.fill("input[name=username]", username);
        page.fill("input[name=password]", password);
        page.click("button[type=submit]");
        page.waitForURL(url -> !url.contains("/login"));
    }

    private void pauseForDemo() throws InterruptedException {
        long pauseMs = Long.parseLong(System.getProperty("playwright.pauseMs", "0"));
        if (pauseMs > 0) {
            Thread.sleep(pauseMs);
        }
    }

    @Test
    @DisplayName("[정상] 일반 텍스트 게시글 작성 및 조회")
    void writeNormalPost_shouldDisplayCorrectly() {
        login("xsstest", "xsspass");

        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "일반 게시글");
        page.fill("textarea[name=content]", "이것은 일반 텍스트입니다.");
        page.click("button[type=submit]");

        page.navigate(baseUrl + "/board");
        assertThat(page.content()).contains("일반 게시글");
    }

    @Test
    @DisplayName("[보안 기대] script 태그는 이스케이프되어 실행되지 않아야 함")
    void storedXss_withScriptTag_shouldNotExecute() throws InterruptedException {
        login("xsstest", "xsspass");

        String xssPayload = "<script>window.xssExecuted=true;</script>";

        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "XSS 테스트 글");
        page.fill("textarea[name=content]", "내용입니다. " + xssPayload);
        page.click("button[type=submit]");

        page.navigate(baseUrl + "/board");
        page.click("text=XSS 테스트 글");

        // 보안 적용 시: 스크립트가 실행되지 않아야 함
        page.waitForLoadState();
        Object result = page.evaluate("() => window.xssExecuted === true");
        assertThat(result).isEqualTo(false);
        pauseForDemo();
    }

    @Test
    @DisplayName("[보안 기대] img onerror 이벤트는 실행되지 않아야 함")
    void storedXss_withImgOnerror_shouldNotExecute() throws InterruptedException {
        login("xsstest", "xsspass");

        String xssPayload = "<img src='x' onerror='window.imgXssExecuted=true'>";

        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "IMG XSS 테스트");
        page.fill("textarea[name=content]", xssPayload);
        page.click("button[type=submit]");

        page.navigate(baseUrl + "/board");
        page.click("text=IMG XSS 테스트");

        // 보안 적용 시: onerror 이벤트가 실행되지 않아야 함
        page.waitForLoadState();
        Object result = page.evaluate("() => window.imgXssExecuted === true");
        assertThat(result).isEqualTo(false);
        pauseForDemo();
    }

    @Test
    @DisplayName("[보안 기대] XSS 페이로드가 텍스트로 표시되어야 함")
    void storedXss_shouldDisplayAsText() throws InterruptedException {
        login("xsstest", "xsspass");

        String xssPayload = "<script>alert('XSS')</script>";

        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "XSS 텍스트 표시 테스트");
        page.fill("textarea[name=content]", xssPayload);
        page.click("button[type=submit]");

        page.navigate(baseUrl + "/board");
        page.click("text=XSS 텍스트 표시 테스트");

        // 보안 적용 시: 스크립트 태그가 텍스트로 보여야 함 (이스케이프됨)
        String content = page.content();
        assertThat(content).contains("&lt;script&gt;");
        pauseForDemo();
    }

    @Test
    @DisplayName("[보안 기대] 쿠키 탈취 시도는 실패해야 함")
    void storedXss_cookieTheft_shouldFail() throws InterruptedException {
        login("xsstest", "xsspass");

        String xssPayload = "<script>window.stolenCookie=document.cookie;</script>";

        page.navigate(baseUrl + "/board/write");
        page.fill("input[name=title]", "쿠키 탈취 테스트");
        page.fill("textarea[name=content]", xssPayload);
        page.click("button[type=submit]");

        page.navigate(baseUrl + "/board");
        page.click("text=쿠키 탈취 테스트");

        // 보안 적용 시: 스크립트 실행 안되므로 stolenCookie는 undefined
        page.waitForLoadState();
        Object stolenCookie = page.evaluate("() => window.stolenCookie");
        assertThat(stolenCookie).isNull();
        pauseForDemo();
    }
}
