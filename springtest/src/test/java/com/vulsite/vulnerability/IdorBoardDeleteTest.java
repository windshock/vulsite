package com.vulsite.vulnerability;

import com.vulsite.entity.Board;
import com.vulsite.entity.User;
import com.vulsite.repository.BoardRepository;
import com.vulsite.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.mock.web.MockHttpSession;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * A담당 - 취약점 #10: IDOR (타사용자 글 삭제) 테스트
 *
 * 테스트 시나리오:
 * 1. 자신의 글 삭제 (정상)
 * 2. 다른 사용자의 글 삭제 시도 (취약점)
 * 3. 관리자 글 삭제 시도 (취약점)
 */
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
@Transactional
class IdorBoardDeleteTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private BoardRepository boardRepository;

    private User attacker;
    private User victim;
    private User admin;

    private Board attackerPost;
    private Board victimPost;
    private Board adminPost;

    @BeforeEach
    void setUp() {
        // 사용자 생성
        attacker = new User("attacker", "attackerpass", "attacker@test.com", "공격자");
        attacker = userRepository.save(attacker);

        victim = new User("victim", "victimpass", "victim@test.com", "피해자");
        victim = userRepository.save(victim);

        admin = new User("adminuser", "adminpass", "admin@test.com", "관리자");
        admin.setAdmin(true);
        admin = userRepository.save(admin);

        // 게시글 생성
        attackerPost = new Board("공격자의 글", "공격자가 작성한 내용", attacker);
        attackerPost = boardRepository.save(attackerPost);

        victimPost = new Board("피해자의 중요한 글", "피해자가 작성한 중요한 내용", victim);
        victimPost = boardRepository.save(victimPost);

        adminPost = new Board("관리자 공지사항", "중요 공지사항입니다.", admin);
        adminPost = boardRepository.save(adminPost);
    }

    private MockHttpSession createLoginSession(User user) {
        MockHttpSession session = new MockHttpSession();
        session.setAttribute("user", user);
        session.setAttribute("userId", user.getId());
        return session;
    }

    @Test
    @DisplayName("[정상] 자신이 작성한 글 삭제")
    void deleteOwnPost_shouldSucceed() throws Exception {
        MockHttpSession session = createLoginSession(attacker);

        mockMvc.perform(post("/board/delete/" + attackerPost.getId())
                        .session(session))
                .andExpect(status().is3xxRedirection())
                .andExpect(redirectedUrl("/board"));

        // DB에서 삭제 확인
        Optional<Board> deleted = boardRepository.findById(attackerPost.getId());
        assertThat(deleted).isEmpty();

        System.out.println("[정상 테스트] 자신의 글 삭제 성공");
    }

    @Test
    @DisplayName("[취약점 #10] IDOR - 다른 사용자의 글 삭제")
    void deleteOtherUserPost_shouldSucceed_vulnerability() throws Exception {
        MockHttpSession session = createLoginSession(attacker);

        Long victimPostId = victimPost.getId();
        String victimPostTitle = victimPost.getTitle();

        // 공격자가 피해자의 글 삭제 시도
        mockMvc.perform(post("/board/delete/" + victimPostId)
                        .session(session))
                .andExpect(status().is3xxRedirection())
                .andExpect(redirectedUrl("/board"));

        // 피해자의 글이 삭제되었는지 확인
        Optional<Board> deleted = boardRepository.findById(victimPostId);
        assertThat(deleted).isEmpty();

        System.out.println("[취약점 확인] IDOR로 타사용자 글 삭제 성공");
        System.out.println("  삭제된 글: " + victimPostTitle + " (작성자: " + victim.getUsername() + ")");
        System.out.println("  삭제 요청자: " + attacker.getUsername());
    }

    @Test
    @DisplayName("[취약점 #10] IDOR - 관리자 공지사항 삭제")
    void deleteAdminPost_shouldSucceed_vulnerability() throws Exception {
        MockHttpSession session = createLoginSession(attacker);

        Long adminPostId = adminPost.getId();

        // 일반 사용자가 관리자 글 삭제 시도
        mockMvc.perform(post("/board/delete/" + adminPostId)
                        .session(session))
                .andExpect(status().is3xxRedirection())
                .andExpect(redirectedUrl("/board"));

        // 관리자 글이 삭제되었는지 확인
        Optional<Board> deleted = boardRepository.findById(adminPostId);
        assertThat(deleted).isEmpty();

        System.out.println("[취약점 확인] 일반 사용자가 관리자 공지사항 삭제 성공");
    }

    @Test
    @DisplayName("[취약점 #10] IDOR - 비로그인 상태에서 글 삭제 시도")
    void deleteWithoutLogin_shouldCheck() throws Exception {
        Long victimPostId = victimPost.getId();

        // 비로그인 상태로 삭제 요청
        mockMvc.perform(post("/board/delete/" + victimPostId))
                .andExpect(status().is3xxRedirection());

        Optional<Board> result = boardRepository.findById(victimPostId);

        if (result.isEmpty()) {
            System.out.println("[취약점 확인] 비로그인 상태에서도 글 삭제 가능");
        } else {
            System.out.println("[정보] 비로그인 상태에서는 글 삭제 불가능");
        }
    }

    @Test
    @DisplayName("[취약점 #10] IDOR - 게시글 ID 브루트포스 삭제")
    void idorBruteforceDelete_shouldExposeVulnerability() throws Exception {
        MockHttpSession session = createLoginSession(attacker);

        // 여러 게시글 생성
        for (int i = 0; i < 5; i++) {
            Board post = new Board("테스트 글 " + i, "내용 " + i, victim);
            boardRepository.save(post);
        }

        long totalBefore = boardRepository.count();
        System.out.println("[브루트포스 시작] 총 게시글 수: " + totalBefore);

        // ID를 순회하며 삭제 시도 (실제 공격 시나리오)
        for (long id = 1; id <= 20; id++) {
            try {
                mockMvc.perform(post("/board/delete/" + id)
                                .session(session))
                        .andExpect(status().is3xxRedirection());

                if (boardRepository.findById(id).isEmpty()) {
                    System.out.println("[IDOR 삭제 성공] boardId=" + id);
                }
            } catch (Exception e) {
                // 존재하지 않는 ID
            }
        }

        long totalAfter = boardRepository.count();
        System.out.println("[브루트포스 완료] 삭제된 게시글 수: " + (totalBefore - totalAfter));
    }

    @Test
    @DisplayName("[취약점 #10] IDOR - 삭제 권한 없음에도 성공하는지 검증")
    void verifyNoAuthorizationCheck() throws Exception {
        MockHttpSession session = createLoginSession(attacker);

        // 피해자의 모든 글 조회
        long victimPostCount = boardRepository.findByAuthorId(victim.getId()).size();
        System.out.println("[공격 전] 피해자의 게시글 수: " + victimPostCount);

        // 피해자의 글 모두 삭제 시도
        for (Board post : boardRepository.findByAuthorId(victim.getId())) {
            mockMvc.perform(post("/board/delete/" + post.getId())
                            .session(session))
                    .andExpect(status().is3xxRedirection());
        }

        // 공격 후 피해자의 게시글 확인
        long remainingPosts = boardRepository.findByAuthorId(victim.getId()).size();
        System.out.println("[공격 후] 피해자의 게시글 수: " + remainingPosts);

        assertThat(remainingPosts).isZero();
        System.out.println("[취약점 확인] 작성자 권한 체크 없이 모든 글 삭제 가능");
    }
}
